# Проектная работа: Прогнозирование количества заказов такси на следующий час

## Описание проекта
Компания такси собрала исторические данные о заказах такси в аэропортах. Чтобы привлекать больше водителей в период пиковой нагрузки, нужно спрогнозировать количество заказов такси на следующий час. Строится модель для такого предсказания.

Значение метрики RMSE на тестовой выборке должно быть не больше 48.

## План по выполнению проекта

1. Загрузить данные и выполнить их ресемплирование по одному часу.
2. Проанализировать данные.
3. Обучить разные модели с различными гиперпараметрами. Сделать тестовую выборку размером 10% от исходных данных.
4. Проверить данные на тестовой выборке и сделать выводы.

## Описание данных

Данные лежат в файле `datasets/taxi.csv`

Количество заказов находится в столбце `num_orders` (от англ. *number of orders*, «число заказов»).

# Исследовательская работа

## Анализ

Рассмотрим первый график временного ряда со скользящими средними с коротким промежутком времени - неделя. Большой промежуток не рассмотрим, т.к. не информативен.

![img.png](image/img.png)

Тут виден, что перед следующим днем кол-во заказов кратно увеличивается, это говорит о том, что люди больше всего заказывают такси в вечерное и ночное время

Теперь рассмотрим график со стационарными рядами

![img_1.png](image/img_1.png)

*Примечание*:
- **Стохастический процесс** - это случайная величина, у которой со временем меняется её распределение. У этой величины есть среднее и дисперсия, которые тоже меняются

Стохастический процесс стационарный (англ. stationary stochastic process), если его распределение со временем не меняется. Например, к такому процессу относятся периодические колебания значений

Если распределение меняется, то процесс называется нестационарным

А что насчет временный ряд, его можно назвать стационарным или нет - нельзя, пока не проверим на тренды, сезонность и остаток декомпозиции

Рассмотрим тренды, сезонность и остаток декомпозиции

###### График тренд

![img_2.png](image/img_2.png)

Видно, что тренд в последнее время увеличивается, т.е. с июня больше заказов на такси поступают нежели остальных

###### График сезонность

Рассмотрим сезонность в коротком промежутке, т.к. на длинном он не приносит мало полезных информаций. Рассмотрим за неделю

![img_3.png](image/img_3.png)

Как и видим, что график представляет собой цикличным способом (выглядит почти как кардиограмма сердца). Можно предполагать, что этот временный ряд стационарен, однако все равно лучше убедиться математическим способом, который приведен ниже

###### График остаток декомпозиции

![img_4.png](image/img_4.png)

По поводу остатка декомпозиции нужно провести исследование отдельно, причем детально, поскольку декомпозиции остатков интрепетировать сложнее, чем сезонность и тренды - в идеале, график остатков должен содержать только шум без систематических компонентов.

Если остатки систематически распределены (например, отрицательны в первой части ряда и примерно равны нуля во второй) или включают некоторую периодическую компоненту, то это свидетельствует о неадекватности модели. Анализ остатков чрезвычайно важен и необходим при анализе временных рядов. Процедура оценивания предполагает, что остатки не коррелированы и нормально распределены.

### Проверка на дисперсию математическим способом

#### Тест Андерсона-Дарлинга

```python
# x - временной ряд
# dist='norm' - ожидаемое распределение (нормальное)
result = anderson(x=df['num_orders'], dist='norm')

# Статистика теста
test_statistic = result.statistic

# Критические значения для разных уровней значимости (1%, 5%, 10%)
critical_values = result.critical_values

# Если статистика теста больше критического значения для выбранного уровня значимости, то дисперсия не является постоянной
if test_statistic > critical_values[2]:
    print("Дисперсия не является постоянной")
else:
    print("Дисперсия является постоянной")
```
```text
output: 
Дисперсия не является постоянной
```

Здесь можно сказать, что этот промежуток времени, т.е. с марта 2018 до конца, является нестанционарным, т.к. присутствует тренд, который стремится увеличиваться, это можно заметить с момента июля 2018. А также дисперсия не является постоянной. Проверим на станционарность математическим способом, что она скажет

### Проверка на стационарность математическим способом

#### Тест Дики-Фуллера

```python
print('='*100)
# тест Дики-Фуллера на стационарность
print('Тест Дики-Фуллера на стационарность')
print('='*100)
result = adfuller(df['num_orders'])

print('ADF Статистка: %f' % result[0])
print('p-value: %f' % result[1])
print('Critical Values:')
for key, value in result[4].items():
    print('\t%s: %.3f' % (key, value))
    
print('='*100)

if(result[1] < 0.05):
    print('Принимаем альтернативную гипотезу. Временной ряд стационарен')
else:
    print('Отвергаем альтернативную гипотезу. Временной ряд не стационарен')
print('='*100)
```
```text
output:
====================================================================================================
Тест Дики-Фуллера на стационарность
====================================================================================================
ADF Статистка: -3.068924
p-value: 0.028940
Critical Values:
	1%: -3.432
	5%: -2.862
	10%: -2.567
====================================================================================================
Принимаем альтернативную гипотезу. Временной ряд стационарен
====================================================================================================
```

#### Тест KPSS - Квятковский-Филлипс-Шмидт-ШинаДики-Фуллер 

```python
print('='*100)
# KPSS-тест на стационарность
# KPSS - Квятковского-Филлипса-Шмидта-Шина
print('KPSS-тест на стационарность')
print('='*100)
result = kpss(df['num_orders'])
print('KPSS Статистка: %f' % result[0])
print('p-value: %f' % result[1])
print('Critical Values:')
for key, value in result[3].items():
    print('\t%s: %.3f' % (key, value))
    
print('='*100)
#### Тест Дики-Фуллера
if(result[1] < 0.05):
    print('Принимаем альтернативную гипотезу. Временной ряд стационарен')
else:
    print('Отвергаем альтернативную гипотезу. Временной ряд не стационарен')
print('='*100)
```
```text
output:
====================================================================================================
KPSS-тест на стационарность
====================================================================================================
KPSS Статистка: 10.913353
p-value: 0.010000
Critical Values:
	10%: 0.347
	5%: 0.463
	2.5%: 0.574
	1%: 0.739
====================================================================================================
Принимаем альтернативную гипотезу. Временной ряд стационарен
====================================================================================================
```

2 разные теста одно и то же говорит, а по графику глазами не сможем судить, что является стационарен или не стационарен. Даже если приглядеться, то можно увидеть небольшой рост, хоть капельку

###### Промежуточный вывод

По графику видно, что перед следующим днем, т.е. ближе к полуночи в вечернее и ночное время поступают больше заказов нежели остальное время, особенное дневное время. 

А также не стоит забывать, что тренд потихоньку растет, но с момента июня 2018 года тренд быстрее увеличивается, это скорее всего какие-то внешние факторы, которые повляляли на частоту заказа такси. 

Также на математическом языке были доказаны следующие тесты:
- На дисперсию
- На стационарность
    - Тест Дики-Фуллера
    - Тест KPSS - Квятковский-Филлипс-Шмидт-ШинаДики-Фуллер

Тест на дисперсию говорит, что не является постоянной, т.е. здесь получилось, что статистика теста больше критического значения для выбранного уровня значимости

А тесты на стационарность дали одинаковые результаты - стационарность, значит, что распределение со временем не меняется.

# Обучение и тестирование

## Семейства модели

На обучение применялись несколько разных сеймейств моделей:
- LinearRegression
- DecisionTreeRegressor
- RandomForestRegressor
- LightGBMRegressor
- CatBoostRegressor
- XGBRegressor

## Результаты

![img_5.png](image/img_5.png)

###### ТОП-3 лучших моделей

![img_6.png](image/img_6.png)

## Тестирование моделей и предсказания на графике

![img_7.png](image/img_7.png)

По графику видно, что предсказания модели в некотором степени отличаются от реальных значений

# Вывод

Самой лучшей моделей является `XGBRegressor` - RMSE составляет **40.18**, а скорость обучения составляет почти 0,02 секунда, время предсказания - 0,005 секунда. Вполне очень акдеватный результат, чтобы выбрать эту модель для реализации. 

Есть другая модель - `LightGBMRegressor`, результаты очень неплохие, идеальный кандидат, чтобы конкурироваться с `XGBRegressor`

А третье место заслужила простая модель - `LinearRegression`, однако эта модель может похвастаться скоростью обучения и предсказанией