# Проектная работа: Обработка фотографий покупателя


## Описание проекта

Сетевой супермаркет «Хлеб-Соль» внедряет систему компьютерного зрения для обработки фотографий покупателей. Фотофиксация в прикассовой зоне поможет определять возраст клиентов, чтобы:

- анализировать покупки и предлагать товары, которые могут заинтересовать покупателей этой возрастной группы;
- контролировать добросовестность кассиров при продаже алкоголя.

Постройте модель, которая по фотографии определит приблизительный возраст человека. В вашем распоряжении набор фотографий людей с указанием возраста.

## Наши цели
- Изучить основы работы с изображениями.
- Познакомиться с библиотекой Keras.
- Разобраться, что такое полносвязные и свёрточные сети.
- Научиться обучать модель ResNet.

## План по выполнению проекта
1. Провести исследовательский анализ набора фотографий.
2. Подготовить данные к обучению.
3. Обучить нейронную сеть и рассчитать её качество.

## Описание данных
Данные взяты с сайта [ChaLearn Looking at People](http://chalearnlap.cvc.uab.es/dataset/26/description/). Они находятся в папке `/datasets/faces/`.

В вашем распоряжении одна папка со всеми изображениями (`/final_files`) и CSV-файл `labels.csv` с двумя колонками: `file_name` и `real_age`.

Извлечь данные из папки вам поможет новый метод [ImageDataGenerator](https://keras.io/preprocessing/image/) — `flow_from_dataframe(dataframe, directory, ...)`.

# Исследовательская работа

После получения датасета выяснили, что у нас есть около 7600 фотографий. 

Указывается, что в каждом фотографии указан возраст человека, проверим, действительно ли указанный возраст человека соответствует по фотографию по логическому соображению.

Выяснили, что: 
- Количество людей с возрастом 1 года: 149
- Количество люди с возрастом 100 лет: 1

###### График распределения возраста человека

![img_1.png](image/img_1.png)

Возраст людей, которые помечены красной и черной линией на графике, часто встречается в датасете - 25 и 30 лет. 

А розовый (фиолетовый) цвет линии на графике, который заполняется каждый 10 лет, свидительствует о том, что в датасете возраст человека заполняли вручную по многими причинами, особенно отсутствия информации возраста человека к фотографии.

Этот график напоминает на пуассоновское распределение, т.е. это статистическое распределение, которое показывает, сколько раз событие может произойти в течение определенного периода времени.

###### Вывод изображений

![img.png](image/img.png)

Вроде все в порядке. Рассмотрим фотографий с возрастом 1 года, проверим на подлинность.

![img_2.png](image/img_2.png)

Вроде нет каких то аномалий, в порядке. Возраст человека по фотографии установлен адекватно. Теперь рассмотрим самый старейший человек

###### Фотографии с самым старейшим человеком

![img_3.png](image/img_3.png)

Вполне соответствует, если не рассмотреть на наличии артефактов

## Промежуточный вывод

На основе вышеперечисленных можно сделать вывод, что чаще всего в датасете встречаются люди с возрастом `30 лет`. А размер выборки соствляет `7591`. Качество изображения с датасет вполне хорошее, мало встречается артефакты, например, у фотографии `000011.jpg` нижняя часть изображения видны.

**Чтобы оценить, достаточно ли имеющихся данных, можно учесть следующие факторы:**

- Разнообразие данных: важно, чтобы датасет был достаточно разнообразным и покрывал широкий спектр возрастов, а также различные этнические группы, пол и другие факторы, которые могут влиять на внешний вид лица. Чем больше разнообразие в данных, тем лучше модель сможет обучиться на различных типах лиц и предсказывать возраст для разных групп.


- Количество данных: более объемный датасет обычно позволяет модели лучше обобщать и обучаться на различных примерах. В данном случае, 7591 запись может быть достаточным количеством данных для некоторых моделей регрессии, но оно может быть недостаточным для более сложных моделей или в случае требования высокой точности предсказания. Например, для научных целей, снятых со спутниковых съемков для исследования уровня глубины океана, рельефа и т.д. 

**В связи с этим, можно предпринять следующие шаги:**

- Аугментация данных: применение различных методов аугментации данных, таких как повороты, сдвиги, изменение размера, изменение яркости и контраста и другие, может помочь увеличить разнообразие и количество данных. Это позволяет модели обучаться на большем количестве вариаций и улучшает ее обобщающую способность.


- Использование предобученных моделей: если доступны предобученные модели, особенно в области анализа изображений и обработки лиц, можно использовать их как основу для своей модели. Это позволяет использовать предварительно обученные веса и архитектуру модели, что может быть полезно при ограниченном количестве данных.


- Добавление дополнительных данных: если у нас есть возможность дополнить еще данные 

## Обучение модели

Обучили модель с готовой предобученной модели `ResNet50`

###### Вывод функции потери
```text
output:

Epoch 1/10
356/356 - 64s - loss: 215.6088 - mae: 10.6122 - val_loss: 705.9674 - val_mae: 21.5358
Epoch 2/10
356/356 - 67s - loss: 84.5707 - mae: 6.9750 - val_loss: 164.0117 - val_mae: 9.6336
Epoch 3/10
356/356 - 69s - loss: 54.7848 - mae: 5.6227 - val_loss: 80.7079 - val_mae: 6.6989
Epoch 4/10
356/356 - 68s - loss: 42.7224 - mae: 4.9490 - val_loss: 92.2831 - val_mae: 7.5083
Epoch 5/10
356/356 - 68s - loss: 33.5699 - mae: 4.4030 - val_loss: 83.9321 - val_mae: 7.0734
Epoch 6/10
356/356 - 43s - loss: 26.1638 - mae: 3.8782 - val_loss: 71.7095 - val_mae: 6.4015
Epoch 7/10
356/356 - 42s - loss: 21.6567 - mae: 3.5772 - val_loss: 74.1264 - val_mae: 6.4298
Epoch 8/10
356/356 - 43s - loss: 18.9548 - mae: 3.3102 - val_loss: 69.2546 - val_mae: 6.2176
Epoch 9/10
356/356 - 43s - loss: 16.3927 - mae: 3.0635 - val_loss: 63.2988 - val_mae: 5.9638
Epoch 10/10
356/356 - 42s - loss: 13.6584 - mae: 2.8123 - val_loss: 65.7167 - val_mae: 6.0708
```

После обучения с применением технологии `ResNet50` **Среднее абсолютная ошибка - MSE** дали неплохие результаты - `6,0708`. Это самая низкая показатель С.А.О _(чем ближе к 0, тем лучше)_. Значит модель редко ошибается по предсказанию возраста человека по фотографии.

Для обучения нейроной сети были использованы следующие использованные архиектуры (backbone, head):
- backbone:
```python
    backbone = ResNet50(input_shape=input_shape,
                weights='/datasets/keras_models/resnet50_weights_tf_dim_ordering_tf_kernels_notop.h5',
                include_top=False)
```
Мы применили `backbone` для заморозки, т.к. она позволяет избавиться от переобучения и повысить скорость обучения сети:  градиентному спуску считать производные для замороженных слоёв не нужно. Потому что у нас небольшой датасет: размер составляет `7591`. Если на таком датасете обучить ResNet50, то она гарантированно переобучится: в ней слишком много параметров — порядка 23 млн. После чего у сети будут идеальные предсказания на обучающей выборке и случайные — на тестовой.

- head:
```python
    model = Sequential()
    model.add(backbone)
    model.add(GlobalAveragePooling2D())
    model.add(Dense(1, activation='relu'))
```

Почему так устанавлены параметры, потому что мы сначала замораживаем в целях избежания переобучения с готовой преодобученной модели `resnet50_weights_tf_dim_ordering_tf_kernels_notop`. Затем добавляем слой `GlobalAveragePooling2D`, чтобы выполнять глобальную операцию среднего пулина, т.е. `average pooling` по пространственным измерениям, которые извлекли еще с признаков. Затем добавили последний выходной полносвязный слой - `Dense`, который принимает входные признаки после глобального среднего пулинга и генерирует предсказания для задачи регрессии - возраста человека.

А теперь ознакомимся со списками параметров обучения:
- Размер батча (`batch_size`) задается в функции загрузки данных (`ImageDataGenerator`), в нашем случае по-умолчанию стоит `None`.
- Оптимизатор (`optimizer`) определен как Adam с коэффициентом скорости обучения (`learning rate`) 0.01.
- Функция потерь (`loss`) установлена как среднеквадратичная ошибка (`mean_squared_error`).
- Метрика (`metrics`) для оценки модели установлена на среднюю абсолютную ошибку (`mean absolute error`, `MAE`).

Чтобы сказать, что модель достигнула необходимые им метрики, наблюдалось ли переобучение, сначала снова рассмотрим на полученную информацию после обучения (см. выше):

- Значение функции потерь (`loss`) уменьшается с каждой эпохой как на обучающей выборке, так и на валидационной выборке. Это говорит о том, что модель успешно учится и снижает ошибку на обоих наборах данных.

- Значение средней абсолютной ошибки (`MAE`) также уменьшается с каждой эпохой как на обучающей выборке, так и на валидационной выборке. Это означает, что модель все более точно предсказывает возраст и улучшает свою производительность.


Извлекем полученные значения, чтобы построить график (Предположим, что данные обучены и извлекли на одном и том же компьютере)

![img_4.png](image/img_4.png)

###### График соотношения функции потерии [loss] к средней абсолютной ошибкой [MAE]

![img_5.png](image/img_5.png)

# Вывод

Как и видим, что вместе с другими значениями функция убывается. Следовательно, на основе этого графика можно сделать вывод, что модель успешно учится и снижает ошибку на обоих наборах данных и все более точно предсказывает возраст и улучшает свою производительность.

**Как понять, что модель переобучена**

**Если наблюдается ситуация, когда сначала качество на валидации росло вместе с качеством на трейне, а потом в какой-то момент качество на валидации начало падать, но при этом на трейне оно продолжило расти, значит началось переобучение.**

